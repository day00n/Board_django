from django.shortcuts import render, get_object_or_404
from django.http import HttpResponse
from .models import BoardList
import requests, traceback
from django.shortcuts import render, redirect
from django.db import connection
from django.views.decorators.csrf import csrf_exempt
from django.contrib import messages

# Create your views here.
TAG_TYPE_MAP = {
	"4062431206512053339" : "ê°œë°œìì˜¤ë¥˜",
	"4062430467230728515" : "ê¸°ì´ˆë°ì´í„°ì˜¤ë¥˜",
	"4046759869914686137" : "ê¸°íƒ€",
	"4062431462386295964" : "ë°ì´í„°ìˆ˜ì •ìš”ì²­",
	"4062431462386295964" : "ë°ì´í„°ë² ì´ìŠ¤ì„¤ê³„ì˜¤ë¥˜",
	"4062431104728936691" : "ì‚¬ìš©ìì‹¤ìˆ˜",
	"4062444602614098566" : "ì†ŒìŠ¤ì½”ë“œë¬¸ì œ",
	"4062430981821462507" : "ì—°ê³„ì˜¤ë¥˜",
	"4062431548321775843" : "í”„ë¡œê·¸ë¨ì—…ê·¸ë ˆì´ë“œ",
	"4053701202528745339" : "DBì„¤ê³„ìˆ˜ì •",
	"4062444602614098566" : "JAVAë‹¨ìˆ˜ì •",
	"4062490455185115159" : "RDìˆ˜ì •",
	"4062491529107142759" : "ê¸°íƒ€",
	"4062490946487267455" : "ë°ì´í„°ìˆ˜ì •",
	"4062430467230728515" : "ì—…ë¬´ê°€ì´ë“œ",
	"4062490642973051206" : "ì™¸ë¶€ì—…ì²´ì „ë‹¬",
	"4062490027540277272" : "ì¿¼ë¦¬ìˆ˜ì •",
	"4062444456885161442" : "í™”ë©´ìˆ˜ì •"
}

def index(request):
    url = "https://api.dooray.com/project/v1/projects/4046755324790625408/posts/"  # API ì£¼ì†Œ
    headers = {
        "Authorization": "dooray-api smoqjaev945f:Z4J-cxpKQ36O0M-Vrd41kQ"
    }   
    count = 0 
    page = 0
    size = 50 
    all_data = []
    while True:
        params = {
            "page": page,
            "size": size,
            "statuses": "open,closed,trash"
        }

        try:
            response = requests.get(url, headers=headers, params=params)
            response.raise_for_status()
            data = response.json()
        except requests.RequestException as e:
            print(f"API ìš”ì²­ ì‹¤íŒ¨: {e}")
            break

        posts = data.get("result", [])
        if not posts:
            break

        for post in posts:
            tags = post.get('tags', [])

            error_id = tags[1]['id'] if len(tags) > 1 else None
            handle_id = tags[2]['id'] if len(tags) > 2 else None

            post['ERROR_TP'] = TAG_TYPE_MAP.get(error_id, 'ì•Œ ìˆ˜ ì—†ìŒ')
            post['HANDLE_TP'] = TAG_TYPE_MAP.get(handle_id, 'ì•Œ ìˆ˜ ì—†ìŒ')

            count += 1
            all_data.append(post)

        print(f"â–¶ í˜„ì¬ {page} í˜ì´ì§€ ì²˜ë¦¬ ì™„ë£Œ, ê²Œì‹œê¸€ ìˆ˜: {len(posts)}")
        page += 1

    print(f"\nì´ ê²Œì‹œê¸€ ìˆ˜: {count}")

    return render(request, 'list.html', {'boards': all_data})

def post(request):
    return render(request, 'post.html')

def detail(request, post_id):
    post = get_object_or_404(BoardList, id=post_id)
    print("ğŸ“Œ ì„ íƒëœ ê²Œì‹œê¸€:", post)
    print("ğŸ“Œ ì œëª©:", post.title)
    print("ğŸ“Œ ë‚´ìš©:", post.content)
    return render(request, 'detail.html', {'post': post})

@csrf_exempt
def sync(request):
    if request.method == "POST":
        try:
            print("â–¶ ë™ê¸°í™” ì‹œì‘")

            url = "https://api.dooray.com/project/v1/projects/4046755324790625408/posts/"  # API ì£¼ì†Œ
            headers = {
                "Authorization": "dooray-api smoqjaev945f:Z4J-cxpKQ36O0M-Vrd41kQ"
            }
            response = requests.get(url, headers=headers)

            print("â–¶ ì‘ë‹µ ì½”ë“œ:", response.status_code)

            response.raise_for_status()
            data_list = response.json().get("data",[])

            print("â–¶ ì‘ë‹µ JSON:", data_list)

            with connection.cursor() as cursor:
                for item in data_list:
                    _id = item.get("id")
                    _sunject = item.get("subject")
                    _created_at = item.get("created_at")
 
                    print(f"[insert] id={_id}, subject={_subject}")
                    cursor.execute("""
                        MERGE INTO BOARD b
                        USING (SELECT :id AS id FROM dual) src
                        ON (b.id = src.id)
                        WHEN NOT MATCHED THEN
                          INSERT (id, subject, created_at)
                          VALUES (:id, :subject, TO_DATE(:created_at, 'YYYY-MM-DD"T"HH24:MI:SS'))
                    """, {
                        'id': _id,
                        'subject': _subject,
                        'created_at': _created_at
                    })
                    print("ì˜í–¥ê°¯ìˆ˜ :", cursor.rowcount)

            messages.success(request, f"{len(data_list)}ê±´ ë™ê¸°í™” ì™„ë£Œ!")
        except Exception as e:
            print("ì˜¤ë¥˜ ë°œìƒ:", e)
            traceback.print_exc()  # ìƒì„¸ ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤ ì¶œë ¥
            messages.error(request, f"ë™ê¸°í™” ì‹¤íŒ¨: {e}")
            print(response.text)
    return redirect('index')



